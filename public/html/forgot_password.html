<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - PSAU Admission System</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link href="css/style.css" rel="stylesheet">
</head>
<body> 
    
    <!-- Reset Container -->
    <div class="container">
        <div class="reset-container">
            <?php if ($success): ?>
                <!-- Success Message -->
                <div class="text-center mb-4">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                    <h2 class="mt-3">Password Reset Successful</h2>
                    <p class="mb-4">Your password has been successfully reset. You can now login with your new password.</p>
                    <div class="d-grid gap-2">
                        <a href="login.php" class="btn btn-psau">Login Now</a>
                    </div>
                </div>
            <?php else: ?>
                <?php if ($step == 1): ?>
                    <!-- Step 1: Email Form -->
                    <h2 class="text-center mb-4">Forgot Password</h2>
                    <p class="text-center mb-4">Enter your email address below and we'll send a verification code for password reset.</p>
                    
                    <?php if (isset($errors['reset'])): ?>
                        <div class="alert alert-danger">
                            <?php echo htmlspecialchars($errors['reset']); ?>
                        </div>
                    <?php endif; ?>
                    
                    <?php if (isset($errors['session'])): ?>
                        <div class="alert alert-warning">
                            <?php echo htmlspecialchars($errors['session']); ?>
                        </div>
                    <?php endif; ?>
                    
                    <?php if (isset($errors['email'])): ?>
                        <div class="alert alert-info">
                            <p><strong>Email Tip:</strong> Make sure you're entering your email exactly as registered.</p>
                            <p class="small mb-0">Check for typos and ensure the email is verified.</p>
                        </div>
                    <?php endif; ?>
                    
                    <form method="POST" action="forgot_password.php">
                        <input type="hidden" name="step" value="1">
                        
                        <div class="mb-3">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" class="form-control <?php echo isset($errors['email']) ? 'is-invalid' : ''; ?>" 
                                id="email" name="email" value="<?php echo htmlspecialchars($email); ?>" 
                                placeholder="Enter your email address" required>
                            <?php if (isset($errors['email'])): ?>
                                <div class="invalid-feedback">
                                    <?php echo htmlspecialchars($errors['email']); ?>
                                </div>
                            <?php endif; ?>
                            <small class="form-text text-muted">
                                Enter the email address associated with your account.
                            </small>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-psau">Continue</button>
                        </div>
                        
                        <div class="reset-footer">
                            <a href="login.php">Back to Login</a>
                        </div>
                    </form>
                <?php elseif ($step == 2): ?>
                    <!-- Step 2: OTP Verification -->
                    <div class="text-center mb-4">
                        <i class="bi bi-shield-lock fs-1 text-success"></i>
                        <h4 class="mt-3">Email Verification</h4>
                        <p>We've sent a verification code to your email address:<br>
                        <strong><?php echo htmlspecialchars($_SESSION['password_reset']['email']); ?></strong></p>
                        <input type="hidden" id="passwordResetEmail" value="<?php echo htmlspecialchars($_SESSION['password_reset']['email']); ?>">
                    </div>
                    
                    <form method="POST" action="forgot_password.php" id="otpForm">
                        <input type="hidden" name="step" value="2">
                        <input type="hidden" name="recaptcha_verified" id="recaptcha_verified" value="false">
                        
                        <div class="mb-3">
                            <label for="otp_code" class="form-label">Enter OTP Code</label>
                            <input type="text" class="form-control form-control-lg text-center <?php echo isset($errors['otp']) ? 'is-invalid' : ''; ?>" 
                                id="otp_code" name="otp_code" placeholder="Enter 6-digit OTP" maxlength="6" required>
                            <?php if (isset($errors['otp'])): ?>
                                <div class="invalid-feedback"><?php echo htmlspecialchars($errors['otp']); ?></div>
                            <?php endif; ?>
                            <div class="form-text mt-2">
                                <i class="bi bi-info-circle"></i> Check your email for a 6-digit verification code.
                            </div>
                        </div>
                        
                        <div id="recaptcha-container" class="mb-3"></div>
                        
                        <div class="d-grid gap-2">
                            <button type="button" id="verify-otp" class="btn btn-psau">Verify OTP</button>
                            <button type="button" id="resend-otp" class="btn btn-outline-secondary">Resend OTP</button>
                            <a href="forgot_password.php" class="btn btn-light">Go Back</a>
                        </div>
                    </form>
                <?php elseif ($step == 3): ?>
                    <!-- Step 3: New Password Form -->
                    <h2 class="text-center mb-4">Reset Password</h2>
                    <p class="text-center mb-4">Please enter your new password below.</p>
                    
                    <form method="POST" action="forgot_password.php">
                        <input type="hidden" name="step" value="3">
                        
                        <div class="mb-3">
                            <label for="password" class="form-label">New Password</label>
                            <div class="input-group">
                            <input type="password" class="form-control <?php echo isset($errors['password']) ? 'is-invalid' : ''; ?>" 
                                id="password" name="password" required>
                                <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                                    <i class="bi bi-eye" id="newPasswordIcon"></i>
                                </button>
                            </div>
                            <?php if (isset($errors['password'])): ?>
                                <div class="invalid-feedback">
                                    <?php echo htmlspecialchars($errors['password']); ?>
                                </div>
                            <?php endif; ?>
                            
                            <div class="password-requirements mt-2">
                                <p class="mb-1">Password must:</p>
                                <ul>
                                    <li id="length">Be at least 8 characters long</li>
                                    <li id="uppercase">Contain at least one uppercase letter</li>
                                    <li id="lowercase">Contain at least one lowercase letter</li>
                                    <li id="number">Contain at least one number</li>
                                    <li id="special">Contain at least one special character</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">Confirm New Password</label>
                            <div class="input-group">
                            <input type="password" class="form-control <?php echo isset($errors['confirm_password']) ? 'is-invalid' : ''; ?>" 
                                id="confirm_password" name="confirm_password" required>
                                <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                    <i class="bi bi-eye" id="confirmPasswordIcon"></i>
                                </button>
                            </div>
                            <?php if (isset($errors['confirm_password'])): ?>
                                <div class="invalid-feedback">
                                    <?php echo htmlspecialchars($errors['confirm_password']); ?>
                                </div>
                            <?php endif; ?>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-psau">Reset Password</button>
                        </div>
                    </form>
                <?php elseif ($step == 4): ?>
                    <!-- Step 4: Success Message -->
                    <div class="text-center">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                        <h2 class="text-success mt-3">Password Reset Successful!</h2>
                        <p class="mb-4">Your password has been successfully updated. You can now log in with your new password.</p>
                        
                        <div class="d-grid gap-2">
                            <a href="login.php" class="btn btn-psau">Go to Login</a>
                            <a href="index.php" class="btn btn-outline-secondary">Return to Home</a>
                        </div>
                    </div>
                <?php endif; ?>
            <?php endif; ?>
        </div>
    </div>


    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <?php if ($step == 2): ?>
    <!-- Firebase scripts for OTP -->
    <script type="module" src="js/forgot_password_otp.js"></script>
    <?php elseif ($step == 3): ?>
    <!-- Password validation script -->
    <script src="js/forgot_password.js"></script>
    <script>
    // Password visibility toggles
    document.addEventListener('DOMContentLoaded', function(){
        const toggleNew = document.getElementById('toggleNewPassword');
        const newPwd = document.getElementById('password');
        const newIcon = document.getElementById('newPasswordIcon');
        if (toggleNew && newPwd && newIcon) {
            toggleNew.addEventListener('click', function(){
                if (newPwd.type === 'password') {
                    newPwd.type = 'text';
                    newIcon.classList.remove('bi-eye');
                    newIcon.classList.add('bi-eye-slash');
                } else {
                    newPwd.type = 'password';
                    newIcon.classList.remove('bi-eye-slash');
                    newIcon.classList.add('bi-eye');
                }
            });
        }

        const toggleConfirm = document.getElementById('toggleConfirmPassword');
        const confirmPwd = document.getElementById('confirm_password');
        const confirmIcon = document.getElementById('confirmPasswordIcon');
        if (toggleConfirm && confirmPwd && confirmIcon) {
            toggleConfirm.addEventListener('click', function(){
                if (confirmPwd.type === 'password') {
                    confirmPwd.type = 'text';
                    confirmIcon.classList.remove('bi-eye');
                    confirmIcon.classList.add('bi-eye-slash');
                } else {
                    confirmPwd.type = 'password';
                    confirmIcon.classList.remove('bi-eye-slash');
                    confirmIcon.classList.add('bi-eye');
                }
            });
        }
    });
    </script>
    <?php endif; ?>
</body>
</html> 